# Traffic Flow Analysis with Multiple Adaptive Vehicle Detectors and Velocity Estimation with Landmark-Based Scanlines
HCM, Vietnam National University team. _16 December 2018_

* Official paper: [IEEE](https://ieeexplore.ieee.org/document/8575374)
* Official code: [Github](https://github.com/HCMUS-Smart-Environment-Group/AICItyChallenge2018)

# Overview

- In this paper, they propose a method for vehicle detection with multiple adaptive vehicle detectors and velocity estimation with landmark-based scanlines.
  
>Inspired by the idea for tiny object detection, we use Faster R-CNN with Resnet-101 to create different specialized vehicle detectors corresponding to different levels of details and poses. We propose a heuristic to check the fitness of a particular vehicle detector to a specific region in camera's view by the mean velocity direction and the mean object size. By this way, we can determine an adaptive set of appropriate vehicle detectors for each region in camera's view. Thus our system is expected to detect vehicles with high accuracy, both in precision and recall, even with tiny objects.

# PROPOSED METHOD

![fig1](../../asset/images/Speed%20Estimation/traffic-flow-annalysis/fig1.jpg)

-  first detect all vehicles in a video clip using multiple vehicle detectors to adapt to different regions in a camera’s view
-  Then, Track the trajectory of a vehicle by linking detected bounding boxes in consecutive frames based on the overlapped region of bounding boxes
-   estimate the velocity of a vehicle exploiting the landmarks on a road using multiple scanlines, parallel lines that are nearly perpendicular to the main moving direction of a lane in that road **main aspect review**
-   several techniques for velocity refinement **main aspect review**

## Vehicle Detection with Multiple Adaptive Object Detectors

1. Multiple Adaptive Object Detectors
- they propose to use multiple object detectors to efficiently detect vehicles in different areas of a camera’s view
- Based on the mean velocity direction and the mean size of a vehicle’s bounding box in each region of the frame, they determine the appropriate detectors from our collection of vehicle detectors that should be applied in that region. 
- we create a detector set D with 3 Faster RCNN detectors: 
  -  the front and back views of a vehicle
  -  the side view of a vehicle
  -  a tiny vehicle which is very far from the camera
  
2. Region-based Adaptive Set of Detectors
- they propose a heuristic to evaluate the fitness of a detector based on the profile of the detector and that of each region in the camera’s view
- For each training sample of a vehicle, we use not only its bounding box but also the instant flow map, generated by FlowNet. The velocity direction of each training sample is defined as the mean of flow map directions.

## Vehicle Tracking with Overlapped Bounding Boxes in Consecutive Frames

- use a simple technique to track vehicles based on the previous frame - IOU

## Velocity Estimation with Scanlines based on Landmarks <Main REVIEW>

> we present our proposed method for approximate calibration based on U.S. road rules for broken white lines painted in roads. 

- Example (Fig.5a):  
   *  segment has a standard length of 10 feet
   *   the gap between two consecutive segments is 30 feet

![fig56](../asset/images/../../../asset/images/Speed%20Estimation/traffic-flow-annalysis/fig5.jpg)

-  As dash lines in the same driving direction are parallel, they propose to draw a virtual scanline passing through the first points of 2 white line segments of 2 adjacent parallel dash lines, and the distance _d_ between the 2 consecutive scanlines.
-  There are 3 cases to estimate the velocity of a vehicle:
   -  The vehicle crosses through at least 2 scanlines
   -  The vehicle crosses only 1 scanline
   -  The vehicle doest not cross any scanline
-  The first case is the main scenario we use for speed estimation

- Figure 6 illustrates our strategy to determine the time instant when a vehicle first crosses a scanline:
  - If the vehicle runs toward the camera, its front is not occluded and crosses the scanline before other parts in the vehicle. the frame when the bounding box of a vehicle first hits the scanline is chosen. 
  -  If the vehicle runs away from the camera, its back is visible and crosses the scanline after all other parts in the vehicle. In this situation, they choose the frame when the bounding box of a vehicle last hits the scanline
  - The timespan (in seconds) for the vehicle to run the distance _d_ between two consecutive scanlines is $t= \frac{f_2 - f_1}{fps}$
  - The average velocity of the vehicle between the two scanlines can be determined with a simple formula _v = d / t_
- In the case that **the vehicle hits only 1 scanline**, they suppose its velocity v = 0
- Last case will be discarded

## Velocity Refinements (Stopped-Moving)

-  in urban areas, especially at crossroads, a vehicle should slow down its speed when it approaches an intersection, stop at a red traffic light, and accelerate its speed when the traffic light turns green. Therefore, it is necessary to detect when a vehicle stops to better estimate its speed.
   -  ==>  calculate the **color similarity** in its bounding box between the current and previous frames using the cosine similarity
-  They also smooth the sequence of states using a smoothing window with the size of 30 frames (equivalent to 1 second).
- use linear interpolation to estimate the velocity for the vehicle when it slows down or accelerates its speed
